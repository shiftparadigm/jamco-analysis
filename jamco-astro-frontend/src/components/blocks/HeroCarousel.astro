---
import { urlFor } from '../../lib/sanity'
import Button from '../ui/Button.astro'

interface Props {
  heading: string
  subheading?: string
  cta?: any
  secondaryCta?: any
  slides: Array<{
    floatingImage?: any
    featureCallout?: any
  }>
}

const {
  heading,
  subheading,
  cta,
  secondaryCta,
  slides = []
} = Astro.props

function getCtaHref(ctaObj: any): string {
  if (!ctaObj) return '#'
  if (ctaObj.linkType === 'external' && ctaObj.externalUrl) return ctaObj.externalUrl
  if (ctaObj.internalLink?.slug) return `/${ctaObj.internalLink.slug}`
  return '#'
}
---

<section class="hero-carousel">
  <div class="hero-container">
    <div class="hero-content">
      <h1>{heading}</h1>
      {subheading && <p class="subheading">{subheading}</p>}

      <div class="hero-ctas">
        {cta && <Button href={getCtaHref(cta)} text={cta.text} variant={cta.style || 'primary'} target={cta.linkType === 'external' ? '_blank' : undefined} />}
        {secondaryCta && (
          <a href={getCtaHref(secondaryCta)} class="text-link" target={secondaryCta.linkType === 'external' ? '_blank' : undefined}>
            {secondaryCta.text} <span class="arrow">→</span>
          </a>
        )}
      </div>
    </div>

    <div class="hero-carousel-wrapper">
      <div class="carousel-slides">
        {slides.map((slide, index) => {
          const imageUrl = slide.floatingImage ? urlFor(slide.floatingImage).width(800).auto('format').url() : null
          return (
            <div class={`carousel-slide ${index === 0 ? 'active' : ''}`} data-slide={index}>
              {imageUrl && (
                <div class="hero-image">
                  <img src={imageUrl} alt={slide.floatingImage?.alt || ''} />

                  {/* Hotspot markers from CMS */}
                  {slide.hotspots && slide.hotspots.map((hotspot: any, i: number) => (
                    <button
                      class={`hotspot hotspot-${i + 1}`}
                      style={`left: ${hotspot.positionX}%; top: ${hotspot.positionY}%;`}
                      data-hotspot={i + 1}
                      aria-label={hotspot.title}
                    >
                      <div class="hotspot-tooltip">
                        <strong>{hotspot.title}</strong>
                        {hotspot.description && <p>{hotspot.description}</p>}
                      </div>
                    </button>
                  ))}

                  {slide.featureCallout && (
                    <div class="feature-callout">
                      <strong>{slide.featureCallout.label}</strong>
                      {slide.featureCallout.description && <p>{slide.featureCallout.description}</p>}
                    </div>
                  )}
                </div>
              )}
            </div>
          )
        })}
      </div>

      {slides.length > 1 && (
        <div class="carousel-controls">
          <span class="carousel-indicator">
            <span class="current-slide">01</span> / {String(slides.length).padStart(2, '0')}
          </span>
          <button class="carousel-nav prev" aria-label="Previous slide">‹</button>
          <button class="carousel-nav next" aria-label="Next slide">›</button>
        </div>
      )}
    </div>
  </div>
</section>

<script>
  let currentSlide = 0
  const slides = document.querySelectorAll('.carousel-slide')
  const indicator = document.querySelector('.current-slide')
  const prevBtn = document.querySelector('.carousel-nav.prev')
  const nextBtn = document.querySelector('.carousel-nav.next')

  function showSlide(index: number) {
    slides.forEach((slide, i) => {
      slide.classList.toggle('active', i === index)
    })
    if (indicator) {
      indicator.textContent = String(index + 1).padStart(2, '0')
    }
    currentSlide = index
  }

  function nextSlide() {
    const next = (currentSlide + 1) % slides.length
    showSlide(next)
  }

  function prevSlide() {
    const prev = (currentSlide - 1 + slides.length) % slides.length
    showSlide(prev)
  }

  if (nextBtn) nextBtn.addEventListener('click', nextSlide)
  if (prevBtn) prevBtn.addEventListener('click', prevSlide)

  // Auto-advance every 5 seconds
  if (slides.length > 1) {
    setInterval(nextSlide, 5000)
  }

  // Hotspot click interactions
  const hotspots = document.querySelectorAll('.hotspot')

  hotspots.forEach(hotspot => {
    hotspot.addEventListener('click', (e) => {
      e.stopPropagation()
      const wasActive = hotspot.classList.contains('active')

      // Close all other hotspots
      hotspots.forEach(h => h.classList.remove('active'))

      // Toggle this one
      if (!wasActive) {
        hotspot.classList.add('active')
      }
    })
  })

  // Close hotspots when clicking outside
  document.addEventListener('click', () => {
    hotspots.forEach(h => h.classList.remove('active'))
  })
</script>

<style>
  .hero-carousel {
    position: relative;
    background: var(--color-light);
    overflow: hidden;
  }

  .hero-carousel::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--overlay-hero);
    z-index: 2;
    pointer-events: none;
  }

  .hero-container {
    position: relative;
    z-index: 1;
    max-width: 1440px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 877px;
    align-items: center;
  }

  .hero-content {
    padding: 4rem 2rem 4rem 4rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 96px;
    font-weight: 300;
    line-height: 0.9;
    letter-spacing: -0.06em;
    color: var(--color-primary);
    margin: 0;
  }

  .subheading {
    font-size: 16px;
    line-height: 1.6;
    letter-spacing: -0.03em;
    color: var(--color-primary);
    max-width: 400px;
    margin: 0;
  }

  .hero-ctas {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
    margin-top: 1rem;
  }

  .text-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-sm);
    font-weight: var(--weight-semibold);
    color: var(--color-primary);
    text-decoration: none;
    transition: gap var(--transition-base);
  }

  .text-link:hover {
    gap: 0.75rem;
  }

  .text-link .arrow {
    font-size: 1.2em;
    transition: transform var(--transition-base);
  }

  .text-link:hover .arrow {
    transform: translateX(2px);
  }

  .hero-carousel-wrapper {
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-slides {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .carousel-slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    pointer-events: none;
  }

  .carousel-slide.active {
    opacity: 1;
    pointer-events: auto;
  }

  .hero-image {
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    max-width: 730px;
    object-fit: contain;
  }

  /* Hotspot markers */
  .hotspot {
    position: absolute;
    width: 24px;
    height: 24px;
    background: rgba(0, 85, 172, 0.8);
    border: 2px solid rgba(255, 255, 255, 1);
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 85, 172, 0.3);
    z-index: 10;
    padding: 0;
  }

  .hotspot:hover,
  .hotspot.active {
    transform: scale(1.3);
    box-shadow: 0 4px 16px rgba(0, 85, 172, 0.5);
  }

  .hotspot-tooltip {
    position: absolute;
    bottom: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 85, 172, 0.95);
    backdrop-filter: blur(8px);
    color: white;
    padding: 12px 16px;
    border-radius: 6px;
    width: 220px;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    text-align: left;
  }

  .hotspot-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: rgba(0, 85, 172, 0.95);
  }

  .hotspot.active .hotspot-tooltip {
    opacity: 1;
    visibility: visible;
  }

  .hotspot-tooltip strong {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .hotspot-tooltip p {
    font-size: 12px;
    line-height: 1.4;
    margin: 0;
    opacity: 0.9;
  }

  /* Hotspot positions are set via inline styles from CMS */

  .feature-callout {
    position: absolute;
    bottom: 80px;
    right: 60px;
    background: rgba(0, 85, 172, 0.5);
    backdrop-filter: blur(10px);
    color: #FFFFFF;
    padding: 1.5rem;
    border-radius: 4px;
    max-width: 256px;
  }

  .feature-callout strong {
    display: block;
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }

  .feature-callout p {
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
    opacity: 0.95;
  }

  .carousel-controls {
    position: absolute;
    bottom: 60px;
    right: 60px;
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 10;
  }

  .carousel-indicator {
    font-size: 14px;
    font-weight: 500;
    color: #666666;
  }

  .carousel-nav {
    width: 40px;
    height: 40px;
    border: 1px solid #666666;
    background: rgba(255, 255, 255, 0.9);
    color: #666666;
    border-radius: 50%;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-nav:hover {
    background: rgb(11, 89, 169);
    color: white;
    border-color: rgb(11, 89, 169);
  }

  @media (max-width: 1024px) {
    .hero-container {
      grid-template-columns: 1fr;
      min-height: auto;
    }

    h1 {
      font-size: 64px;
    }

    .hero-content {
      padding: 3rem 2rem;
    }

    .carousel-slides {
      min-height: 400px;
    }

    .feature-callout {
      bottom: 40px;
      right: 40px;
      max-width: 200px;
    }
  }

  @media (max-width: 768px) {
    .hero-carousel {
      padding-bottom: 2rem;
    }

    h1 {
      font-size: 40px;
      letter-spacing: -0.04em;
    }

    .subheading {
      font-size: 14px;
    }

    .hero-content {
      padding: 1.5rem 1rem;
      gap: 1rem;
    }

    .hero-ctas {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .hero-image {
      padding: 1rem;
    }

    .hero-image img {
      max-width: 100%;
    }

    .hotspot {
      display: none;
    }

    .feature-callout {
      position: absolute;
      bottom: 10px;
      right: 10px;
      left: auto;
      max-width: 180px;
      padding: 0.75rem;
      font-size: 12px;
    }

    .feature-callout strong {
      font-size: 14px;
    }

    .feature-callout p {
      font-size: 11px;
    }

    .carousel-controls {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: auto;
      margin-top: 0;
      gap: 0.5rem;
    }

    .carousel-nav {
      width: 32px;
      height: 32px;
      font-size: 18px;
    }

    .carousel-indicator {
      font-size: 12px;
    }
  }
</style>
